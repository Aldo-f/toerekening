<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toerekening Calculator</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .input-panel { flex: 1; min-width: 350px; }
        .output-panel { flex: 2; min-width: 500px; }
        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { 
            width: 100%; 
            padding: 8px; 
            margin-bottom: 10px; 
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        button.danger { background: #dc3545; padding: 5px 10px; }
        button.danger:hover { background: #c82333; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 13px;
        }
        th, td { 
            padding: 6px 4px; 
            text-align: right; 
            border-bottom: 1px solid #ddd;
        }
        th { background: #f8f9fa; text-align: center; font-size: 12px; }
        td:first-child, th:first-child { text-align: left; }
        .entry-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
        .entry-row input { margin: 0; }
        .entry-row .date-input { width: 100px; }
        .entry-row .debt-input { width: 90px; }
        .entry-row .payment-input { width: 90px; }
        .entry-row .rate-input { width: 60px; }
        .share-url {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
        }
        .total-row { font-weight: bold; background: #f8f9fa; }
        .error { color: #dc3545; margin-top: 10px; }
        .info { color: #666; font-size: 14px; margin-top: 5px; }
        .header-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .header-row > div { flex: 1; min-width: 200px; }
    </style>
</head>
<body>
    <h1>Toerekening Calculator</h1>
    <p class="info">Berekening volgens art. 5.210 BW (betalingen worden eerst op interest aangerekend)</p>
    
    <div class="container">
        <div class="input-panel">
            <div class="card">
                <h3>Start</h3>
                <div class="header-row">
                    <div>
                        <label>Initiële schuld (€)</label>
                        <input type="number" id="initialDebt" step="0.01" value="3000">
                    </div>
                    <div>
                        <label>Rentevoet (%)</label>
                        <input type="number" id="initialRate" step="0.01" value="2">
                    </div>
                </div>
                <label>Startdatum</label>
                <input type="text" id="initialDate" placeholder="dd/mm/yyyy" value="22/05/2016">
            </div>
            
            <div class="card">
                <h3>Betalingen</h3>
                <div id="entries"></div>
                <button onclick="addEntry()">+ Voeg betaling toe</button>
            </div>
            
            <div class="card">
                <button onclick="calculate()">Bereken</button>
                <button class="secondary" onclick="resetForm()">Reset</button>
                <button class="secondary" onclick="copyUrl()">Kopieer URL</button>
            </div>
            
            <div class="card">
                <h3>Deel deze berekening</h3>
                <div class="share-url" id="shareUrl"></div>
            </div>
        </div>
        
        <div class="output-panel">
            <div class="card">
                <h3>Resultaat</h3>
                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Dagen</th>
                            <th>Schuld</th>
                            <th>Afbetaling</th>
                            <th>Rentevoet</th>
                            <th>Hoofdsom</th>
                            <th>Interest</th>
                            <th>Toerekening</th>
                            <th>Saldo</th>
                            <th>Totaal</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function parseDate(str) {
            const parts = str.split('/');
            if (parts.length !== 3) return null;
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        
        function formatDate(date) {
            const d = String(date.getDate()).padStart(2, '0');
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const y = date.getFullYear();
            return `${d}/${m}/${y}`;
        }
        
        function calcDays(d1, d2) {
            return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
        }
        
        // Round to 2 decimal places
        function round2(num) {
            return Math.round(num * 100) / 100;
        }
        
        function calcInterest(principal, rate, days) {
            return round2(principal * rate / 100 * days / 365);
        }
        
        function formatEuro(amount) {
            if (amount === 0) return '€ -';
            return '€ ' + amount.toFixed(2).replace('.', ',');
        }
        
        function addEntry(date = '', debt = '', payment = '', rate = '') {
            const div = document.createElement('div');
            div.className = 'entry-row';
            div.innerHTML = `
                <input type="text" class="date-input" placeholder="dd/mm/yyyy" value="${date}">
                <input type="number" class="debt-input" step="0.01" placeholder="Schuld" value="${debt}">
                <input type="number" class="payment-input" step="0.01" placeholder="Betaling" value="${payment}">
                <input type="number" class="rate-input" step="0.01" placeholder="%" value="${rate}">
                <button class="danger" onclick="this.parentElement.remove(); updateShareUrl();">×</button>
            `;
            document.getElementById('entries').appendChild(div);
        }
        
        function getEntries() {
            const rows = document.querySelectorAll('#entries .entry-row');
            const result = [];
            rows.forEach(row => {
                const date = row.querySelector('.date-input').value;
                const debt = parseFloat(row.querySelector('.debt-input').value) || 0;
                const payment = parseFloat(row.querySelector('.payment-input').value) || 0;
                const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
                if (date) result.push({ date, debt, payment, rate });
            });
            return result;
        }
        
        function calculate() {
            const initialDebt = parseFloat(document.getElementById('initialDebt').value) || 0;
            const initialRate = parseFloat(document.getElementById('initialRate').value) || 0;
            const initialDateStr = document.getElementById('initialDate').value;
            const initialDate = parseDate(initialDateStr);
            
            if (!initialDate) {
                alert('Ongeldige startdatum');
                return;
            }
            
            const entriesData = getEntries();
            
            // Build full list with initial entry - calculate days automatically
            let allDates = [{ date: initialDate, debt: initialDebt, payment: 0, rate: initialRate, days: 0 }];
            let prevDate = initialDate;
            
            entriesData.forEach(e => {
                const d = parseDate(e.date);
                if (d) {
                    const days = calcDays(prevDate, d);
                    allDates.push({ date: d, debt: e.debt, payment: e.payment, rate: e.rate, days });
                    prevDate = d;
                }
            });
            
            // Debug: log the parsed entries
            console.log('All dates:', allDates);
            
            // Calculate toerekening
            // According to art. 5.210 BW: payments are first allocated to interest
            let principal = initialDebt;
            let toerekening = 0;
            const results = [];
            
            for (let i = 0; i < allDates.length; i++) {
                const entry = allDates[i];
                
                // Calculate interest for this period
                const interest = calcInterest(principal, entry.rate, entry.days);
                
                // Add interest to toerekening
                toerekening = round2(toerekening + interest);
                
                // Apply payment (first to interest/toerekening, then principal)
                if (entry.payment < 0) {
                    const paymentAbs = Math.abs(entry.payment);
                    toerekening = round2(toerekening - paymentAbs);
                    
                    // If payment exceeds toerekening, the excess goes to principal
                    if (toerekening < 0) {
                        // The excess payment reduces principal
                        principal = round2(principal + toerekening);
                        toerekening = 0;
                    }
                }
                
                // Add any new debt (this happens AFTER interest calculation)
                if (entry.debt > 0) {
                    principal = round2(principal + entry.debt);
                }
                
                const saldo = round2(principal + toerekening);
                const totaal = round2(saldo + interest);
                
                console.log(`Row ${i+1}: principal=${principal}, interest=${interest}, toerekening=${toerekening}, saldo=${saldo}, totaal=${totaal}`);
                
                results.push({
                    date: formatDate(entry.date),
                    days: entry.days,
                    debt: entry.debt,
                    payment: entry.payment,
                    rate: entry.rate,
                    principal: principal,
                    interest: interest,
                    toerekening: toerekening,
                    saldo: saldo,
                    totaal: totaal
                });
            }
            
            // Render table
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = results.map(r => `
                <tr>
                    <td>${r.date}</td>
                    <td>${r.days}</td>
                    <td>${r.debt > 0 ? formatEuro(r.debt) : '€ -'}</td>
                    <td>${r.payment < 0 ? formatEuro(r.payment) : '€ -'}</td>
                    <td>${r.rate}%</td>
                    <td>€${r.principal.toFixed(2)}</td>
                    <td>€${r.interest.toFixed(2)}</td>
                    <td>€${r.toerekening.toFixed(2)}</td>
                    <td>€${r.saldo.toFixed(2)}</td>
                    <td>€${r.totaal.toFixed(2)}</td>
                </tr>
            `).join('');
            
            updateShareUrl();
        }
        
        function updateShareUrl() {
            const initialDebt = document.getElementById('initialDebt').value;
            const initialRate = document.getElementById('initialRate').value;
            const initialDate = document.getElementById('initialDate').value;
            const entriesData = getEntries();
            
            const params = new URLSearchParams();
            params.set('d', initialDebt);
            params.set('r', initialRate);
            params.set('s', initialDate);
            
            if (entriesData.length > 0) {
                const entriesStr = entriesData.map(e => 
                    `${e.date},${e.debt},${e.payment},${e.rate}`
                ).join('|');
                params.set('e', entriesStr);
            }
            
            const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            document.getElementById('shareUrl').textContent = url;
        }
        
        function loadFromUrl() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('d')) {
                document.getElementById('initialDebt').value = params.get('d');
            }
            if (params.has('r')) {
                document.getElementById('initialRate').value = params.get('r');
            }
            if (params.has('s')) {
                document.getElementById('initialDate').value = params.get('s');
            }
            
            if (params.has('e')) {
                document.getElementById('entries').innerHTML = '';
                const entriesStr = params.get('e').split('|');
                entriesStr.forEach(entry => {
                    const [date, debt, payment, rate] = entry.split(',');
                    addEntry(date, debt, payment, rate);
                });
            }
            
            if (params.has('d') || params.has('e')) {
                calculate();
            }
        }
        
        function copyUrl() {
            const url = document.getElementById('shareUrl').textContent;
            navigator.clipboard.writeText(url).then(() => {
                alert('URL gekopieerd naar klembord!');
            });
        }
        
        function resetForm() {
            document.getElementById('initialDebt').value = '3000';
            document.getElementById('initialRate').value = '2';
            document.getElementById('initialDate').value = '22/05/2016';
            document.getElementById('entries').innerHTML = '';
            document.getElementById('resultBody').innerHTML = '';
            history.replaceState({}, '', window.location.pathname);
            updateShareUrl();
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFromUrl();
        });
    </script>
</body>
</html>
